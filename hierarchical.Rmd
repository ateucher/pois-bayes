---
title: "Hierarhical"
author: "Andy Teucher"
date: "November 21, 2014"
output: html_document
---

```{r}
source("header.R")
library(bayesm)
data(cheese)
```

First a few plots:

```{r}
qplot(DISP, VOLUME, data = cheese, alpha = 0.1)
qplot(log(PRICE), VOLUME, data = cheese, alpha = 0.1)
```



```{r}
ch_model <- jags_model("model {
  alpha ~ dnorm(0, 20^-2)
  beta ~ dnorm(0, 2^-2)
  beta2 ~ dnorm(0, 2^-2)
  sigma ~ dunif(0, 2)
  
  for(i in 1:length(VOLUME)) {
    eLogVolume[i] <- alpha + beta*DISP[i] + beta2*PRICE[i]
    VOLUME[i] ~ dlnorm(eLogVolume[i], sigma^-2) # Use log-normal dist bc vol can't be negative
  }
}", 
derived_code = "data {
  for(i in 1:length(VOLUME)) {
    log(prediction[i]) <- alpha + beta*DISP[i] + beta2*PRICE[i]
  }
}",
select_data = c("VOLUME", "log(PRICE)*", "DISP*"))

opts_jagr(mode = "report") # Set debug mode so does minimum work to check if it runs
ch_analysis <- jags_analysis(ch_model, data = cheese)
plot(ch_analysis)

price <- predict(ch_analysis, newdata = "PRICE")

gp <- ggplot(price, aes(x = PRICE, y = estimate)) + 
  geom_line() + 
  geom_line(aes(y = lower), linetype = "dashed") + 
  geom_line(aes(y = upper), linetype = "dashed") + 
  expand_limits(y = 0)
gp

disp <- predict(ch_analysis, newdata = "DISP")

gp %+% disp + aes(x = DISP)
```


